<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    #the-canvas {
      border: 1px solid black;
      direction: ltr;
    }
  </style>
  <script src="https://mozilla.github.io/pdf.js/build/pdf.mjs" type="module"></script>
  <script src="https://unpkg.com/pdf-lib@1.4.0/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/downloadjs@1.4.7/download.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>

  <script type="module">
    // If absolute URL from the remote server is provided, configure the CORS
    // header on that server.
    // var url = 'https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/web/compressed.tracemonkey-pldi-09.pdf';
    var url = '/sample.pdf';

    // Loaded via <script> tag, create shortcut to access PDF.js exports.
    var { pdfjsLib } = globalThis;

    // The workerSrc property shall be specified.
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.mjs';

    var pdfDoc = null,
      pageNum = 1,
      pageRendering = false,
      pageNumPending = null,
      scale = 1,
      canvas = document.getElementById('the-canvas'),
      ctx = canvas.getContext('2d');

    /**
     * Get page info from document, resize canvas accordingly, and render page.
     * @param num Page number.
     */
    function renderPage(num) {
      pageRendering = true;
      // Using promise to fetch the page
      pdfDoc.getPage(num).then(function (page) {
        var viewport = page.getViewport({ scale: scale });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        // Render PDF page into canvas context
        var renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        var renderTask = page.render(renderContext);

        // Wait for rendering to finish
        renderTask.promise.then(function () {
          console.log("renderTask")
          pageRendering = false;
          if (pageNumPending !== null) {
            console.log("pageRendering")
            // New page rendering is pending
            renderPage(pageNumPending);
            pageNumPending = null;
          }
          ctx.beginPath();
          // Set the stroke color
          ctx.strokeStyle = "#080808"; // Red color
          // Set the rectangle dimensions and position
          var x = 350;
          var y = 500;
          var width = 100;
          var height = 100;
          // Draw the unfilled rectangle
          ctx.strokeRect(x, y, width, height);

          ctx.beginPath();
          ctx.strokeStyle = "#FF0000"; // Red color
          ctx.lineWidth = 2; // Red color
          ctx.arc(400, 550, 40, 0, 2 * Math.PI);
          ctx.stroke();
        });
      });

      // Update page counters
      document.getElementById('page_num').textContent = num;
    }

    /**
     * If another page rendering in progress, waits until the rendering is
     * finised. Otherwise, executes rendering immediately.
     */
    function queueRenderPage(num) {
      if (pageRendering) {
        pageNumPending = num;
      } else {
        renderPage(num);
      }
    }

    /**
     * Displays previous page.
     */
    function onPrevPage() {
      if (pageNum <= 1) {
        return;
      }
      pageNum--;
      queueRenderPage(pageNum);
    }
    document.getElementById('prev').addEventListener('click', onPrevPage);

    /**
     * Displays next page.
     */
    function onNextPage() {
      if (pageNum >= pdfDoc.numPages) {
        return;
      }
      pageNum++;
      queueRenderPage(pageNum);
    }
    document.getElementById('next').addEventListener('click', onNextPage);

    /**
     * Asynchronously downloads PDF.
     */
    pdfjsLib.getDocument(url).promise.then(function (pdfDoc_) {
      pdfDoc = pdfDoc_;
      document.getElementById('page_count').textContent = pdfDoc.numPages;

      // Initial/first page rendering
      renderPage(pageNum);
    });

    canvas.addEventListener('click', function (e) {
      // Handle the click event here
      console.log('Clicked on PDF!', e);
      handleSign();
    });

    function handleSign() {
      // 400 550
      const text = "HUNG";
      const textCanvas = document.querySelector('.measureTextWidth');
      const context = textCanvas.getContext('2d');
      context.font = '20px Arial';
      const metrics = context.measureText(text);
      const textWidth = metrics.width;
      const textHeight = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
      ctx.beginPath();
      ctx.font = "20px Arial";
      ctx.fillText(text, 372, 556);
    }

    function downloadPDF() {
      console.log("canvas", canvas)
      // canvas.toBlob(function (blob) {
      //   var link = document.createElement('a');
      //   const file = new File([blob], 'sample');
      //   link.href = URL.createObjectURL(file);
      //   link.download = "sample.pdf"
      //   console.log("blob", blob, URL.createObjectURL(file), file)
      //   link.click();
      // }, 'application/pdf');
      var imgData = canvas.toDataURL("image/jpeg", 1.0);
      var pdf = new jsPDF();

      pdf.addImage(imgData, 'JPEG', 0, 0);
      pdf.save("download.pdf");
    }

    document.getElementById('download').addEventListener('click', function (e) {
      // Handle the click event here
      // downloadPDF();
      modifyPdf();
    });

    const { degrees, PDFDocument, rgb, StandardFonts } = PDFLib

    async function modifyPdf() {
      // Fetch an existing PDF document
      const url = '/sample.pdf'
      const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer())

      // Load a PDFDocument from the existing PDF bytes
      const pdfDoc = await PDFDocument.load(existingPdfBytes)

      // Embed the Helvetica font
      const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica)

      // Get the first page of the document
      const pages = pdfDoc.getPages()
      const firstPage = pages[0]
      const secondPage = pages[1]

      // Get the width and height of the first page
      const { width, height } = firstPage.getSize()
      const context = firstPage.getContentStream();
      console.log("firstPage", firstPage, pages, height)

      // Draw a string of text diagonally across the first page
      firstPage.drawText('This text was added with JavaScript!', {
        x: 5,
        y: height / 2 + 300,
        size: 50,
        font: helveticaFont,
        color: rgb(0.95, 0.1, 0.1),
        rotate: degrees(-45),
      })

      secondPage.drawText('This text was added with JavaScript!', {
        x: 5,
        y: height / 2 + 300,
        size: 50,
        font: helveticaFont,
        color: rgb(0.95, 0.1, 0.1),
        rotate: degrees(-45),
      })

      const circleX = 400; // X-coordinate of the circle center
      const circleY = 550; // Y-coordinate of the circle center
      const circleRadius = 25; // Radius of the circle

      firstPage.drawEllipse({
        context,
        x: circleX - circleRadius,
        y: height - circleY - circleRadius, // Invert Y-axis for PDF coordinates
        width: circleRadius * 2,
        height: circleRadius * 2,
        color: rgb(0, 0, 0), // Circle color
        borderWidth: 1, // Border width (optional)
        borderColor: rgb(0, 0, 0), // Border color (optional)
      });


      const rectX = 350;
      const rectY = 500;
      const rectWidth = 100;
      const rectHeight = 100;

      secondPage.drawRectangle({
        context,
        x: rectX,
        y: height - rectY - rectHeight,
        width: rectWidth,
        height: rectHeight,
        color: rgb(0, 0, 0),
        borderWidth: 1,
        borderColor: rgb(0, 0, 0),
      });

      // Serialize the PDFDocument to bytes (a Uint8Array)
      const pdfBytes = await pdfDoc.save()

      // Trigger the browser to download the PDF document
      download(pdfBytes, "sample.pdf", "application/pdf");
    }
  </script>
</head>

<body>
  <h1>PDF.js Previous/Next example</h1>

  <p>Please use <a href="https://mozilla.github.io/pdf.js/getting_started/#download"><i>official releases</i></a> in
    production environments.</p>

  <div>
    <button id="download">Download</button>
    <button id="prev">Previous</button>
    <button id="next">Next</button>
    &nbsp; &nbsp;
    <span>Page: <span id="page_num"></span> / <span id="page_count"></span></span>
  </div>

  <canvas id="the-canvas"></canvas>
  <canvas class="d-none measureTextWidth"></canvas>
</body>

</html>